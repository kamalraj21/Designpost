import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Download, 
  Type, 
  Palette, 
  User, 
  Layout, 
  ChevronLeft, 
  ChevronRight, 
  Sparkles,
  RefreshCw,
  FileText,
  X,
  Send,
  AlignCenter,
  AlignLeft,
  Settings2,
  MoveVertical
} from 'lucide-react';

const loadScript = (src) => {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
};

const THEMES = [
  { id: 'dark', name: 'Elite Dark', bg: '#000000', text: '#ffffff', accent: '#3b82f6', secondary: 'rgba(255,255,255,0.1)' },
  { id: 'light', name: 'Clean White', bg: '#ffffff', text: '#000000', accent: '#2563eb', secondary: 'rgba(0,0,0,0.05)' },
  { id: 'brand', name: 'LinkedIn Blue', bg: '#0a66c2', text: '#ffffff', accent: '#ffffff', secondary: 'rgba(255,255,255,0.2)' },
  { id: 'soft', name: 'Soft Gray', bg: '#f8fafc', text: '#1e293b', accent: '#6366f1', secondary: 'rgba(99,102,241,0.1)' },
];

const App = () => {
  const [slides, setSlides] = useState([
    { id: 1, title: 'Stop Your Text From Getting Cropped', content: 'We fixed the layout engine to ensure every word is visible, even on mobile devices.', tag: 'PRO TIP' },
    { id: 2, title: 'The Safe Zone Principle', content: 'LinkedIn UI elements (arrows and page numbers) overlap your content. We built an automatic buffer to keep your text clear.', tag: 'DESIGN' },
    { id: 3, title: 'Ready to Export?', content: 'Hit the download button. Your carousel is rendered at a crisp 1080x1080 resolution.', tag: 'FINAL STEP' },
  ]);

  const [settings, setSettings] = useState({
    theme: THEMES[0],
    userName: 'John Doe',
    handle: '@johndoe_content',
    alignment: 'left',
    titleSize: 84,
    contentSize: 42,
    verticalSpacing: 40,
  });

  const [activeSlide, setActiveSlide] = useState(0);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [showImportModal, setShowImportModal] = useState(false);
  const [rawText, setRawText] = useState('');
  
  const exportRefs = useRef([]);

  useEffect(() => {
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  }, []);

  const updateSlide = (index, field, value) => {
    const newSlides = [...slides];
    newSlides[index][field] = value;
    setSlides(newSlides);
  };

  const processWithAI = async (input, mode = 'topic') => {
    setIsAiLoading(true);
    const apiKey = ""; 
    const systemPrompt = `LinkedIn expert. Structure into JSON slides: { "slides": [{ "title": "...", "content": "...", "tag": "..." }] }. Max 10 slides. Keep content brief to avoid cropping.`;
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: mode === 'raw' ? `Analyze: ${input}` : `Create: ${input}` }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });
      const data = await response.json();
      const result = JSON.parse(data.candidates[0].content.parts[0].text);
      if (result.slides) {
        setSlides(result.slides.map((s, i) => ({ ...s, id: Date.now() + i })));
        setActiveSlide(0);
        setShowImportModal(false);
      }
    } catch (e) { console.error(e); } finally { setIsAiLoading(false); }
  };

  const exportPDF = async () => {
    if (!window.html2canvas || !window.jspdf) return;
    setIsGenerating(true);
    const { jsPDF } = window.jspdf;
    
    try {
      const pdf = new jsPDF({
        orientation: 'p',
        unit: 'px',
        format: [1080, 1080]
      });

      for (let i = 0; i < slides.length; i++) {
        const element = exportRefs.current[i];
        
        // Use html2canvas with specific settings for high-quality static capture
        const canvas = await window.html2canvas(element, {
          scale: 1, // Element is already 1080x1080
          useCORS: true,
          logging: false,
          width: 1080,
          height: 1080,
          backgroundColor: settings.theme.bg,
        });

        if (i > 0) pdf.addPage([1080, 1080]);
        pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, 1080, 1080);
      }

      pdf.save(`carousel-${Date.now()}.pdf`);
    } catch (error) {
      console.error("PDF Export failed", error);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="min-h-screen bg-slate-100 flex flex-col md:flex-row font-sans text-slate-900 h-screen overflow-hidden">
      {/* LEFT CONTROL PANEL */}
      <div className="w-full md:w-[450px] bg-white border-r border-slate-200 flex flex-col shadow-xl z-30">
        <div className="p-6 border-b flex justify-between items-center">
          <h1 className="text-xl font-black text-blue-600 flex items-center gap-2">
            <Layout size={24} /> CAROUSEL PRO
          </h1>
          <button 
            onClick={() => setShowImportModal(true)}
            className="text-[10px] font-bold bg-slate-900 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 hover:bg-blue-600 transition-colors"
          >
            <FileText size={14} /> IMPORT TEXT
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-8 pb-32">
          {/* Design Section */}
          <section className="space-y-4">
            <div className="flex items-center justify-between">
              <label className="text-xs font-black text-slate-400 uppercase tracking-widest">Global Style</label>
              <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                <button onClick={() => setSettings({...settings, alignment: 'left'})} className={`p-1.5 rounded ${settings.alignment === 'left' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}><AlignLeft size={16}/></button>
                <button onClick={() => setSettings({...settings, alignment: 'center'})} className={`p-1.5 rounded ${settings.alignment === 'center' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}><AlignCenter size={16}/></button>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-2">
              {THEMES.map(t => (
                <button 
                  key={t.id} 
                  onClick={() => setSettings({...settings, theme: t})}
                  className={`p-3 rounded-xl border-2 transition-all flex items-center gap-3 ${settings.theme.id === t.id ? 'border-blue-500 bg-blue-50' : 'border-slate-100 bg-slate-50 hover:border-slate-200'}`}
                >
                  <div className="w-4 h-4 rounded-full border border-slate-300" style={{backgroundColor: t.bg}} />
                  <span className="text-xs font-bold">{t.name}</span>
                </button>
              ))}
            </div>

            <div className="space-y-4 pt-2">
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-4">
                <div>
                  <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase">Headline Size: {settings.titleSize}px</div>
                  <input type="range" min="40" max="120" value={settings.titleSize} onChange={(e) => setSettings({...settings, titleSize: parseInt(e.target.value)})} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                </div>
                <div>
                  <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase">Content Size: {settings.contentSize}px</div>
                  <input type="range" min="20" max="80" value={settings.contentSize} onChange={(e) => setSettings({...settings, contentSize: parseInt(e.target.value)})} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                </div>
                <div>
                  <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase flex items-center gap-1"><MoveVertical size={12}/> Vertical Shift: {settings.verticalSpacing}px</div>
                  <input type="range" min="0" max="150" value={settings.verticalSpacing} onChange={(e) => setSettings({...settings, verticalSpacing: parseInt(e.target.value)})} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-2">
              <input value={settings.userName} onChange={(e) => setSettings({...settings, userName: e.target.value})} className="p-3 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="User Name" />
              <input value={settings.handle} onChange={(e) => setSettings({...settings, handle: e.target.value})} className="p-3 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="@handle" />
            </div>
          </section>

          {/* Slide Management Section */}
          <section className="space-y-4">
            <div className="flex items-center justify-between border-t pt-6">
              <label className="text-xs font-black text-slate-400 uppercase tracking-widest">Slides ({slides.length})</label>
              <button onClick={() => processWithAI(slides[0].title)} className="text-xs font-bold text-blue-600 flex items-center gap-1 hover:underline">
                <Sparkles size={14} /> AI REFINE
              </button>
            </div>
            
            <div className="space-y-3">
              {slides.map((s, idx) => (
                <div key={s.id} onClick={() => setActiveSlide(idx)} className={`p-4 rounded-2xl border-2 transition-all cursor-pointer ${activeSlide === idx ? 'border-blue-500 bg-white shadow-lg' : 'border-slate-100 bg-slate-50'}`}>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-[10px] font-black px-2 py-0.5 rounded bg-blue-100 text-blue-600 uppercase">Slide {idx + 1}</span>
                    <button onClick={(e) => { e.stopPropagation(); setSlides(slides.filter((_, i) => i !== idx)); }} className="text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={16}/></button>
                  </div>
                  <input value={s.title} onChange={(e) => updateSlide(idx, 'title', e.target.value)} className="w-full font-bold text-sm bg-transparent border-none outline-none focus:text-blue-600" placeholder="Headline" />
                  <textarea value={s.content} onChange={(e) => updateSlide(idx, 'content', e.target.value)} className="w-full text-xs text-slate-500 bg-transparent border-none outline-none mt-1 resize-none h-12" placeholder="Body copy..." />
                </div>
              ))}
            </div>

            <button onClick={() => setSlides([...slides, { id: Date.now(), title: 'New Slide', content: 'Content goes here', tag: 'INSIGHT' }])} className="w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-xs font-bold text-slate-400 hover:text-blue-500 hover:border-blue-300 transition-all flex items-center justify-center gap-2 uppercase">
              <Plus size={16} /> Add Slide
            </button>
          </section>
        </div>

        <div className="p-6 bg-slate-50 border-t sticky bottom-0">
          <button onClick={exportPDF} disabled={isGenerating} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black text-sm shadow-xl shadow-blue-200 flex items-center justify-center gap-3 transition-all active:scale-95 disabled:opacity-50">
            {isGenerating ? <RefreshCw className="animate-spin" /> : <Download size={20} />}
            GENERATE LINKEDIN PDF
          </button>
        </div>
      </div>

      {/* RIGHT PREVIEW CANVAS */}
      <div className="flex-1 flex flex-col items-center justify-center p-8 overflow-hidden bg-slate-200">
        <div className="w-full max-w-[540px] aspect-square relative group">
          
          {/* NAVIGATION GHOSTS (Simulating LinkedIn Arrows) */}
          <div className="absolute inset-y-0 -left-12 flex items-center z-10 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onClick={() => setActiveSlide(Math.max(0, activeSlide-1))} className="p-2 bg-white rounded-full shadow-lg hover:text-blue-600 disabled:opacity-30" disabled={activeSlide === 0}><ChevronLeft size={32}/></button>
          </div>
          <div className="absolute inset-y-0 -right-12 flex items-center z-10 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onClick={() => setActiveSlide(Math.min(slides.length-1, activeSlide+1))} className="p-2 bg-white rounded-full shadow-lg hover:text-blue-600 disabled:opacity-30" disabled={activeSlide === slides.length-1}><ChevronRight size={32}/></button>
          </div>

          {/* THE ACTUAL PREVIEW ELEMENT */}
          <div 
            className="w-full h-full rounded-[40px] shadow-2xl relative overflow-hidden flex flex-col transition-all duration-300"
            style={{ backgroundColor: settings.theme.bg, color: settings.theme.text }}
          >
            {/* Background Accent */}
            <div className="absolute -top-1/4 -right-1/4 w-full h-full rounded-full blur-[100px] opacity-20 pointer-events-none" style={{ backgroundColor: settings.theme.accent }} />

            {/* HEADER AREA */}
            <div className="h-[15%] p-8 md:p-10 flex justify-between items-start z-10">
              <div className="px-3 py-1 rounded-full text-[10px] md:text-xs font-black uppercase tracking-widest border border-current border-opacity-20" style={{backgroundColor: settings.theme.secondary}}>
                {slides[activeSlide].tag || 'Carousel'}
              </div>
              <div className="flex gap-1">
                {slides.map((_, i) => (
                  <div key={i} className={`h-1 rounded-full transition-all ${activeSlide === i ? 'w-6 bg-current opacity-100' : 'w-1 bg-current opacity-20'}`} />
                ))}
              </div>
            </div>

            {/* MAIN CONTENT AREA - Centered middle section */}
            <div className="flex-1 px-10 md:px-14 flex flex-col justify-center overflow-hidden z-10" style={{ paddingBottom: `${settings.verticalSpacing}px` }}>
              <div className={settings.alignment === 'center' ? 'text-center' : 'text-left'}>
                <h1 
                  className="font-black leading-[1.1] tracking-tighter mb-6 break-words"
                  style={{ fontSize: `${settings.titleSize / 2}px` }} 
                >
                  {slides[activeSlide].title}
                </h1>
                <p 
                  className="font-medium opacity-80 leading-relaxed break-words"
                  style={{ fontSize: `${settings.contentSize / 2}px` }}
                >
                  {slides[activeSlide].content}
                </p>
              </div>
            </div>

            {/* FOOTER AREA */}
            <div className="h-[20%] p-10 flex justify-between items-end border-t border-current border-opacity-5 z-10">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 md:w-12 md:h-12 rounded-2xl flex items-center justify-center" style={{backgroundColor: settings.theme.secondary}}>
                  <User size={24}/>
                </div>
                <div>
                  <p className="text-sm md:text-base font-black">{settings.userName}</p>
                  <p className="text-[10px] md:text-xs opacity-50 font-bold">{settings.handle}</p>
                </div>
              </div>
              <div className="text-3xl font-black opacity-10">{(activeSlide + 1).toString().padStart(2, '0')}</div>
            </div>
          </div>
          
          <div className="mt-8 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.4em]">
            Real-Time 1:1 Aspect Ratio
          </div>
        </div>
      </div>

      {/* HIDDEN RENDER ENGINE - Forcing 1080x1080 capture */}
      <div className="fixed -left-[4000px] top-0 pointer-events-none">
        {slides.map((s, idx) => (
          <div
            key={s.id}
            ref={el => (exportRefs.current[idx] = el)}
            style={{ 
              width: '1080px', 
              height: '1080px', 
              backgroundColor: settings.theme.bg, 
              color: settings.theme.text,
              display: 'flex',
              flexDirection: 'column',
              position: 'relative',
              overflow: 'hidden'
            }}
          >
            <div className="absolute -top-[200px] -right-[200px] w-[800px] h-[800px] rounded-full blur-[200px] opacity-20" style={{ backgroundColor: settings.theme.accent }} />
            
            <header className="h-[150px] p-24 flex justify-between items-start">
              <div className="px-10 py-3 rounded-full text-3xl font-black uppercase tracking-[0.2em]" style={{backgroundColor: settings.theme.secondary}}>
                {s.tag || 'Insight'}
              </div>
              <div className="w-48 h-3 bg-current opacity-20 rounded-full mt-5" />
            </header>

            <main className="flex-1 px-24 flex flex-col justify-center" style={{ paddingBottom: `${settings.verticalSpacing * 2}px` }}>
              <div className={settings.alignment === 'center' ? 'text-center' : 'text-left'}>
                <h1 className="font-black leading-[1.05] tracking-tighter mb-12" style={{ fontSize: `${settings.titleSize}px` }}>{s.title}</h1>
                <p className="font-medium opacity-80 leading-relaxed" style={{ fontSize: `${settings.contentSize}px` }}>{s.content}</p>
              </div>
            </main>

            <footer className="h-[220px] px-24 pb-20 flex justify-between items-end border-t-4 border-current border-opacity-5">
              <div className="flex items-center gap-10">
                <div className="w-32 h-32 rounded-[40px] flex items-center justify-center shadow-lg" style={{backgroundColor: settings.theme.secondary}}>
                  <User size={64}/>
                </div>
                <div>
                  <p className="text-4xl font-black">{settings.userName}</p>
                  <p className="text-2xl opacity-50 font-bold mt-2">{settings.handle}</p>
                </div>
              </div>
              <div className="text-9xl font-black opacity-10 italic">{(idx + 1).toString().padStart(2, '0')}</div>
            </footer>
          </div>
        ))}
      </div>

      {/* MODAL */}
      {showImportModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-md p-6">
          <div className="bg-white w-full max-w-2xl rounded-[32px] shadow-2xl p-10 space-y-8 animate-in zoom-in duration-200">
            <header className="flex justify-between items-start">
              <div>
                <h3 className="text-2xl font-black text-slate-900 uppercase">Input Raw Content</h3>
                <p className="text-slate-500 text-sm mt-1">Paste an article or notes to generate a structured carousel draft.</p>
              </div>
              <button onClick={() => setShowImportModal(false)} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><X size={24}/></button>
            </header>
            <textarea
              value={rawText} onChange={(e) => setRawText(e.target.value)}
              placeholder="Paste article, notes, or long-form posts here..."
              className="w-full h-80 p-8 bg-slate-50 border-2 border-slate-100 rounded-3xl text-sm outline-none focus:border-blue-500 transition-all resize-none shadow-inner font-medium leading-relaxed"
            />
            <button
              onClick={() => processWithAI(rawText, 'raw')}
              disabled={isAiLoading || !rawText.trim()}
              className="w-full py-5 bg-blue-600 text-white rounded-[24px] font-black shadow-2xl shadow-blue-300 disabled:opacity-50 flex items-center justify-center gap-3 transition-all hover:bg-blue-700"
            >
              {isAiLoading ? <RefreshCw className="animate-spin" /> : <Send size={20} />}
              GENERATE CAROUSEL STRUCTURE
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;

